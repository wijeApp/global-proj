<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Connection Test - GlobalVen</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/style.css}">
    
    <style>
        .test-card {
            transition: all 0.3s ease;
        }
        
        .test-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .status-success {
            color: #28a745;
        }
        
        .status-failed {
            color: #dc3545;
        }
        
        .status-testing {
            color: #ffc107;
        }
        
        .result-box {
            background-color: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .result-success {
            border-left-color: #28a745;
            background-color: #d4edda;
        }
        
        .result-error {
            border-left-color: #dc3545;
            background-color: #f8d7da;
        }
        
        .loading-spinner {
            display: none;
        }
        
        .test-button {
            min-width: 120px;
        }
    </style>
</head>
<body>
    <!-- Navigation Menu -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-building"></i> GlobalVen
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="bi bi-house-door"></i> Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/transactions">
                            <i class="bi bi-receipt"></i> Transactions
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Page Header -->
    <div class="page-header">
        <div class="container">
            <h1><i class="bi bi-database-check"></i> Database Connection Test</h1>
            <p class="lead">Test and verify database connections and GL reference codes API</p>
        </div>
    </div>

    <!-- Content Section -->
    <section class="content-section">
        <div class="container">
            <!-- Quick Status Overview -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="bi bi-speedometer2"></i> Quick Status Check
                            </h5>
                            <div class="row text-center">
                                <div class="col-md-3">
                                    <div id="mysqlStatus" class="p-3">
                                        <i class="bi bi-database fs-1"></i>
                                        <h6>MySQL Connection</h6>
                                        <span class="badge bg-secondary">Not Tested</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div id="sqlserverStatus" class="p-3">
                                        <i class="bi bi-server fs-1"></i>
                                        <h6>SQL Server Connection</h6>
                                        <span class="badge bg-secondary">Not Tested</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div id="storedProcStatus" class="p-3">
                                        <i class="bi bi-gear fs-1"></i>
                                        <h6>Stored Procedure</h6>
                                        <span class="badge bg-secondary">Not Tested</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div id="apiStatus" class="p-3">
                                        <i class="bi bi-api fs-1"></i>
                                        <h6>GL Codes API</h6>
                                        <span class="badge bg-secondary">Not Tested</span>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center mt-3">
                                <button class="btn btn-primary" onclick="runAllTests()">
                                    <i class="bi bi-play-circle"></i> Run All Tests
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test Cards -->
            <div class="row">
                <!-- MySQL Connection Test -->
                <div class="col-lg-6 mb-4">
                    <div class="card test-card">
                        <div class="card-header">
                            <h5><i class="bi bi-database"></i> MySQL Connection Test</h5>
                        </div>
                        <div class="card-body">
                            <p>Test the primary MySQL database connection.</p>
                            <button class="btn btn-outline-primary test-button" onclick="testMySqlConnection()">
                                <span class="loading-spinner spinner-border spinner-border-sm me-2"></span>
                                Test MySQL
                            </button>
                            <div id="mysqlResult" class="result-box" style="display: none;">
                                <pre></pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SQL Server Connection Test -->
                <div class="col-lg-6 mb-4">
                    <div class="card test-card">
                        <div class="card-header">
                            <h5><i class="bi bi-server"></i> SQL Server Connection Test</h5>
                        </div>
                        <div class="card-body">
                            <p>Test the SQL Server connection to TasGlobalDB.</p>
                            <button class="btn btn-outline-info test-button" onclick="testSqlServerConnection()">
                                <span class="loading-spinner spinner-border spinner-border-sm me-2"></span>
                                Test SQL Server
                            </button>
                            <div id="sqlserverResult" class="result-box" style="display: none;">
                                <pre></pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SQL Server Query Test -->
                <div class="col-lg-6 mb-4">
                    <div class="card test-card">
                        <div class="card-header">
                            <h5><i class="bi bi-search"></i> SQL Server Query Test</h5>
                        </div>
                        <div class="card-body">
                            <p>Test basic SQL queries on SQL Server.</p>
                            <button class="btn btn-outline-warning test-button" onclick="testSqlServerQuery()">
                                <span class="loading-spinner spinner-border spinner-border-sm me-2"></span>
                                Test Query
                            </button>
                            <div id="queryResult" class="result-box" style="display: none;">
                                <pre></pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stored Procedure Test -->
                <div class="col-lg-6 mb-4">
                    <div class="card test-card">
                        <div class="card-header">
                            <h5><i class="bi bi-gear"></i> Stored Procedure Test</h5>
                        </div>
                        <div class="card-body">
                            <p>Check if GET_GLREF_CODES stored procedure exists.</p>
                            <button class="btn btn-outline-secondary test-button" onclick="testStoredProcedure()">
                                <span class="loading-spinner spinner-border spinner-border-sm me-2"></span>
                                Check Procedure
                            </button>
                            <div id="procedureResult" class="result-box" style="display: none;">
                                <pre></pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Direct Stored Procedure Execution -->
                <div class="col-lg-6 mb-4">
                    <div class="card test-card">
                        <div class="card-header">
                            <h5><i class="bi bi-play-circle"></i> Direct Procedure Execution</h5>
                        </div>
                        <div class="card-body">
                            <p>Execute GET_GLREF_CODES stored procedure directly.</p>
                            <button class="btn btn-outline-success test-button" onclick="testDirectStoredProcedure()">
                                <span class="loading-spinner spinner-border spinner-border-sm me-2"></span>
                                Execute Direct
                            </button>
                            <div id="directResult" class="result-box" style="display: none;">
                                <pre></pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- GL Codes API Test -->
                <div class="col-lg-6 mb-4">
                    <div class="card test-card">
                        <div class="card-header">
                            <h5><i class="bi bi-api"></i> GL Codes API Test</h5>
                        </div>
                        <div class="card-body">
                            <p>Test the GL reference codes API service.</p>
                            <button class="btn btn-outline-danger test-button" onclick="testGlCodesApi()">
                                <span class="loading-spinner spinner-border spinner-border-sm me-2"></span>
                                Test API
                            </button>
                            <div id="apiResult" class="result-box" style="display: none;">
                                <pre></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Comprehensive Test -->
            <div class="row">
                <div class="col-12 mb-4">
                    <div class="card test-card">
                        <div class="card-header">
                            <h5><i class="bi bi-check2-all"></i> Comprehensive GL Codes Test</h5>
                        </div>
                        <div class="card-body">
                            <p>Run all GL reference codes API methods and show detailed results.</p>
                            <button class="btn btn-primary test-button" onclick="testComprehensive()">
                                <span class="loading-spinner spinner-border spinner-border-sm me-2"></span>
                                Run Comprehensive Test
                            </button>
                            <div id="comprehensiveResult" class="result-box" style="display: none;">
                                <pre></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Connection Info -->
            <div class="row">
                <div class="col-12 mb-4">
                    <div class="card test-card">
                        <div class="card-header">
                            <h5><i class="bi bi-info-circle"></i> Connection Information</h5>
                        </div>
                        <div class="card-body">
                            <p>Get detailed information about database connections.</p>
                            <button class="btn btn-outline-info test-button" onclick="getConnectionInfo()">
                                <span class="loading-spinner spinner-border spinner-border-sm me-2"></span>
                                Get Info
                            </button>
                            <div id="connectionInfoResult" class="result-box" style="display: none;">
                                <pre></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container text-center">
            <p class="mb-0">&copy; 2024 GlobalVen. Database Testing Interface.</p>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Test functions
        async function testMySqlConnection() {
            await runTest('/api/test/mysql-connection', 'mysqlResult', 'mysqlStatus');
        }

        async function testSqlServerConnection() {
            await runTest('/api/test/sqlserver-connection', 'sqlserverResult', 'sqlserverStatus');
        }

        async function testSqlServerQuery() {
            await runTest('/api/test/sqlserver-query', 'queryResult');
        }

        async function testStoredProcedure() {
            await runTest('/api/test/stored-procedure-check', 'procedureResult', 'storedProcStatus');
        }

        async function testDirectStoredProcedure() {
            await runTest('/api/test/direct-stored-procedure', 'directResult');
        }

        async function testGlCodesApi() {
            await runTest('/api/test/glref-codes-api', 'apiResult', 'apiStatus');
        }

        async function testComprehensive() {
            await runTest('/api/test/glref-codes-comprehensive', 'comprehensiveResult');
        }

        async function getConnectionInfo() {
            await runTest('/api/test/connection-info', 'connectionInfoResult');
        }

        async function runAllTests() {
            const tests = [
                { func: testMySqlConnection, name: 'MySQL Connection' },
                { func: testSqlServerConnection, name: 'SQL Server Connection' },
                { func: testSqlServerQuery, name: 'SQL Server Query' },
                { func: testStoredProcedure, name: 'Stored Procedure Check' },
                { func: testDirectStoredProcedure, name: 'Direct Procedure Execution' },
                { func: testGlCodesApi, name: 'GL Codes API' }
            ];

            for (let i = 0; i < tests.length; i++) {
                console.log(`Running ${tests[i].name}...`);
                await tests[i].func();
                // Small delay between tests
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            showToast('All tests completed!', 'success');
        }

        async function runTest(endpoint, resultElementId, statusElementId = null) {
            const button = event.target;
            const spinner = button.querySelector('.loading-spinner');
            const resultElement = document.getElementById(resultElementId);
            
            // Show loading state
            button.disabled = true;
            spinner.style.display = 'inline-block';
            
            if (statusElementId) {
                updateStatus(statusElementId, 'testing', 'Testing...');
            }

            try {
                const response = await fetch(endpoint);
                const data = await response.json();
                
                // Display results
                resultElement.style.display = 'block';
                resultElement.querySelector('pre').textContent = JSON.stringify(data, null, 2);
                
                // Update result styling
                if (data.status === 'SUCCESS') {
                    resultElement.className = 'result-box result-success';
                    if (statusElementId) {
                        updateStatus(statusElementId, 'success', 'Success');
                    }
                } else {
                    resultElement.className = 'result-box result-error';
                    if (statusElementId) {
                        updateStatus(statusElementId, 'failed', 'Failed');
                    }
                }
                
            } catch (error) {
                resultElement.style.display = 'block';
                resultElement.className = 'result-box result-error';
                resultElement.querySelector('pre').textContent = `Error: ${error.message}`;
                
                if (statusElementId) {
                    updateStatus(statusElementId, 'failed', 'Error');
                }
            } finally {
                // Hide loading state
                button.disabled = false;
                spinner.style.display = 'none';
            }
        }

        function updateStatus(elementId, status, text) {
            const element = document.getElementById(elementId);
            const badge = element.querySelector('.badge');
            
            badge.textContent = text;
            badge.className = 'badge';
            
            switch (status) {
                case 'success':
                    badge.classList.add('bg-success');
                    break;
                case 'failed':
                    badge.classList.add('bg-danger');
                    break;
                case 'testing':
                    badge.classList.add('bg-warning');
                    break;
                default:
                    badge.classList.add('bg-secondary');
            }
        }

        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer') || createToastContainer();
            
            const toast = document.createElement('div');
            toast.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }

        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toastContainer';
            container.style.cssText = 'position: fixed; top: 0; right: 0; z-index: 9999;';
            document.body.appendChild(container);
            return container;
        }
    </script>
</body>
</html>
